---
title: "High level structure"
date: "2023-01-20"
---
```{r}
library(shrinkforest)
```


In this vignette we are going to briefly describe the high level structure of the functions used (the main ones and the helper ones) in this package.

## Helper functions

### Generate_stacked_data
The `generate_stacked_data` function is used to generate a data frame with the data stacked by the subgroups. 

We gather the columns of the different variables and we create two columns: one with the subgroup variable and the other one with the value of the subgroup variable. Doing this we are going to increase the number of rows of the data frame (the new number of rows is going to be the initial one times the number of subgroup variables). Finally, we sort the rows of the new data frame by the subgroup and we output this sorted data frame.


### Preprocess
The `preprocess` function is used to obtain from the original data frame 3 different design matrices and a vector with the name of the subgroups that are going to be studied. 

The first of the matrices is `design_ia` which is the design matrix of a model just with the interactions between treatment and the subgrouping covariates.

Another matrix is `design_main` which is the design matrix of a model with the main effects of treatment and the subgroup variables. 

The last matrix is `design_dummy` which is the matrix of a model just with the subgrouping covariates and using one-hot encoding. 

To obtain all these matrices we just obtain the design matrices of some specified models (for example just considering one of the covariates) and when needed we bind them to obtain the three desired matrices.

Finally we also obtain the vector `subgr_names` with the exact name of the different subgroups that we are going to study.


## Main functions

### Naivepop
The `naivepop` function is used to estimate the subgroup treatment effects with the naive overall population treatment effect. 

In this function we make a distinction depending on the type of data that we have. In the case of survival data we fit a Cox regression model (using coxph) with treatment as explanatory variable. Instead, if we have binary data, we fit a logistic regression model (using glm with the binomial family) with treatment as explanatory variable. This fitted model is going to be included as part of the output of our function.


### Naive
The `naive`function is used to estimate the subgroup treatment effects with the naive treatment effects per subgroup.

In this function we make a distinction between binary and survival data (the main difference between them is that in binary we are going to use glm models with the binomial family and in survival we are going to use coxph models). With `generate_stacked_data` we obtain the stacked by subgroups data frame and we fit a model (depending on the type of response the glm or the coxph) on each one of the data sets corresponding to a specific subgroup. These fitted models are going to be part of the output as well as a data set with the components of the summary of those models that are going to be useful to obtain the treatment effect.


### Elastic_net
The `elastic_net` function is used to estimate the subgroup treatment effects
using penalization on the interaction terms between treatment and the 
subgroup covariates.

We are going to use the function cv.glmnet to fit the model. We are going to consider the design matrix (obtained after applying to the data the function `preprocess`) with the main effects and the interaction effects and we are going to create a penalty_factor vector with entries 0 if the coefficients are not going to be penalized (as for the main effects) and 1 if they are going to be penalized (as for the interaction effects). Depending on the kind of data that we have we are going to consider the cox family (for survival) or the binomial family (for binary). The value of alpha is the elastic net mixing parameter and can take values between 0 and 1. If we put it to 1 we are going to apply lasso penalty on the interaction effects and if we put it to 0 we are going to apply ridge penalty on the interaction effects.


### Horseshoe
The `horseshoe`function is used to estimate the subgroup treatment effects
using a bayesian model with a horseshoe prior on the interaction terms between treatment and the subgroup covariates.

We are going to apply the function `preprocess` to our data in order to obtain the design matrix needed to fit the model. Then we use the brm function to fit our model and we are going to consider a normal N(0,5) prior on the main effects and a regularized horseshoe prior on the interaction effects. Depending on the kind of data we are going to choose the cox family (for survival data) or the bernoulli family (for binary data). In the case of survival data before fitting the model we specify what is the shape (the boundary and the internal knots) of the spline that is going to fit the baseline hazard. 



